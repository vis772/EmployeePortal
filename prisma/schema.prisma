// Prisma schema for Nova Creations Employee Portal
// Run `npx prisma generate` after changes

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User account for authentication
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         Role     @default(EMPLOYEE)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Two-Factor Authentication
  totpSecret    String?   // Encrypted TOTP secret
  totpEnabled   Boolean   @default(false)
  backupCodes   String?   // JSON array of hashed backup codes

  // Relations
  employeeProfile     EmployeeProfile?
  announcements       Announcement[]        @relation("CreatedAnnouncements")
  passwordResetTokens PasswordResetToken[]
  auditLogs           AuditLog[]            @relation("AuditUser")

  @@index([email])
}

enum Role {
  ADMIN
  EMPLOYEE
}

// Employee profile with personal and employment details
model EmployeeProfile {
  id                          String           @id @default(cuid())
  userId                      String           @unique
  user                        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Personal info
  fullName                    String?
  dateOfBirth                 DateTime?
  phone                       String?
  address                     String?
  
  // Emergency contact
  emergencyContactName        String?
  emergencyContactRelationship String?
  emergencyContactPhone       String?
  
  // Employment details
  roleTitle                   String?
  startDate                   DateTime?
  employmentType              EmploymentType?
  wage                        Decimal?         @db.Decimal(10, 2)
  
  // Onboarding status
  onboardingStatus            OnboardingStatus @default(NOT_STARTED)
  onboardingCompletedAt       DateTime?
  
  createdAt                   DateTime         @default(now())
  updatedAt                   DateTime         @updatedAt

  // Relations
  bankDetails                 BankDetails?
  onboardingSteps             EmployeeOnboardingStep[]
  agreements                  EmployeeAgreement[]
  documents                   EmployeeDocument[]
  ptoRequests                 PTORequest[]
  ptoBalance                  PTOBalance?
  payStubs                    PayStub[]

  @@index([onboardingStatus])
}

enum EmploymentType {
  HOURLY
  SALARY
}

enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

// Bank/payment details for employee
model BankDetails {
  id              String      @id @default(cuid())
  employeeId      String      @unique
  employee        EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  bankName        String
  accountType     AccountType
  routingNumber   String
  accountNumber   String      // In production, encrypt this
  last4Account    String      // Derived from accountNumber for display
  confirmed       Boolean     @default(false)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

enum AccountType {
  CHECKING
  SAVINGS
}

// Template for onboarding steps (configurable by admin)
model OnboardingStepTemplate {
  id          String   @id @default(cuid())
  name        String
  key         String   @unique // e.g., "personal_info", "bank_info"
  description String?
  order       Int
  isRequired  Boolean  @default(true)
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  employeeSteps EmployeeOnboardingStep[]

  @@index([order])
}

// Employee's progress on onboarding steps
model EmployeeOnboardingStep {
  id             String                 @id @default(cuid())
  employeeId     String
  employee       EmployeeProfile        @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  stepTemplateId String
  stepTemplate   OnboardingStepTemplate @relation(fields: [stepTemplateId], references: [id], onDelete: Cascade)
  
  status         StepStatus             @default(NOT_STARTED)
  completedAt    DateTime?
  
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  @@unique([employeeId, stepTemplateId])
  @@index([employeeId])
}

enum StepStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

// Template for agreements/documents employees must sign
model AgreementTemplate {
  id          String   @id @default(cuid())
  title       String
  description String?
  pdfUrl      String   // URL to the PDF document
  isRequired  Boolean  @default(true)
  isActive    Boolean  @default(true)
  order       Int
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  employeeAgreements EmployeeAgreement[]

  @@index([order])
}

// Employee's acceptance of agreements
model EmployeeAgreement {
  id                  String            @id @default(cuid())
  employeeId          String
  employee            EmployeeProfile   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  agreementTemplateId String
  agreementTemplate   AgreementTemplate @relation(fields: [agreementTemplateId], references: [id], onDelete: Cascade)
  
  accepted            Boolean           @default(false)
  acceptedAt          DateTime?
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@unique([employeeId, agreementTemplateId])
  @@index([employeeId])
}

// Documents uploaded by employees
model EmployeeDocument {
  id         String          @id @default(cuid())
  employeeId String
  employee   EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  type       DocumentType
  fileName   String
  fileUrl    String          // In production, this would be S3/cloud storage URL
  mimeType   String?
  fileSize   Int?            // Size in bytes
  
  uploadedAt DateTime        @default(now())

  @@index([employeeId])
}

enum DocumentType {
  ID
  DRIVERS_LICENSE
  PASSPORT
  ONBOARDING_PDF
  OTHER
}

// Announcements posted by admins
model Announcement {
  id               String   @id @default(cuid())
  title            String
  body             String
  isActive         Boolean  @default(true)
  
  createdByAdminId String
  createdByAdmin   User     @relation("CreatedAnnouncements", fields: [createdByAdminId], references: [id])
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([isActive, createdAt])
}

// ==================== PTO REQUEST SYSTEM ====================

// PTO Balance for each employee
model PTOBalance {
  id              String          @id @default(cuid())
  employeeId      String          @unique
  employee        EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  vacationDays    Decimal         @default(0) @db.Decimal(5, 2)  // Total vacation days
  sickDays        Decimal         @default(0) @db.Decimal(5, 2)  // Total sick days
  personalDays    Decimal         @default(0) @db.Decimal(5, 2)  // Total personal days
  
  vacationUsed    Decimal         @default(0) @db.Decimal(5, 2)  // Used vacation days
  sickUsed        Decimal         @default(0) @db.Decimal(5, 2)  // Used sick days
  personalUsed    Decimal         @default(0) @db.Decimal(5, 2)  // Used personal days
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

// PTO Request
model PTORequest {
  id              String          @id @default(cuid())
  employeeId      String
  employee        EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  type            PTOType
  startDate       DateTime
  endDate         DateTime
  totalDays       Decimal         @db.Decimal(5, 2)
  reason          String?
  
  status          PTOStatus       @default(PENDING)
  reviewedById    String?         // Admin who reviewed
  reviewedAt      DateTime?
  reviewNotes     String?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([employeeId])
  @@index([status])
}

enum PTOType {
  VACATION
  SICK
  PERSONAL
}

enum PTOStatus {
  PENDING
  APPROVED
  DENIED
  CANCELLED
}

// ==================== PAY STUBS ====================

model PayStub {
  id              String          @id @default(cuid())
  employeeId      String
  employee        EmployeeProfile @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  payPeriodStart  DateTime
  payPeriodEnd    DateTime
  payDate         DateTime
  
  grossPay        Decimal         @db.Decimal(10, 2)
  netPay          Decimal         @db.Decimal(10, 2)
  
  // Deductions stored as JSON for flexibility
  deductions      String?         // JSON: {federal: 100, state: 50, insurance: 75, etc}
  
  hoursWorked     Decimal?        @db.Decimal(6, 2)
  hourlyRate      Decimal?        @db.Decimal(8, 2)
  
  fileName        String
  fileUrl         String
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([employeeId])
  @@index([payDate])
}

// ==================== AUDIT LOGS ====================

model AuditLog {
  id          String      @id @default(cuid())
  userId      String?     // Can be null for system actions
  user        User?       @relation("AuditUser", fields: [userId], references: [id], onDelete: SetNull)
  
  action      AuditAction
  entityType  String      // e.g., "User", "PTORequest", "PayStub"
  entityId    String?     // ID of the affected entity
  
  details     String?     // JSON with additional details
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime    @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
}

enum AuditAction {
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_RESET_REQUEST
  PASSWORD_RESET_COMPLETE
  TWO_FACTOR_ENABLED
  TWO_FACTOR_DISABLED
  PROFILE_UPDATE
  EMPLOYEE_CREATE
  EMPLOYEE_UPDATE
  EMPLOYEE_DELETE
  PTO_REQUEST_CREATE
  PTO_REQUEST_APPROVE
  PTO_REQUEST_DENY
  PTO_REQUEST_CANCEL
  PAYSTUB_UPLOAD
  PAYSTUB_VIEW
  DOCUMENT_UPLOAD
  DOCUMENT_VIEW
  SETTINGS_UPDATE
}

// ==================== PASSWORD RESET ====================

model PasswordResetToken {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  token       String   @unique  // Hashed token
  expiresAt   DateTime
  usedAt      DateTime?
  
  createdAt   DateTime @default(now())

  @@index([token])
  @@index([userId])
}

